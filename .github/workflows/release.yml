name: Release

on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.ref_name }}   # for the same branch
  cancel-in-progress: true        # run only one workflow at a time (cancel the previous)

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Resolve version
        id: version
        uses: lukashornych/semantic-calendar-version@v1.1.3
        with:
          prefix: 'v'
          minor-identifier: '/feat(?:\\([^)]+\\))?:/'

      - name: Generate version file
        run: echo "${{ steps.version.outputs.version }}" | sed 's/^v//' > version

      - name: Package release archive
        run: |
          mkdir hole
          cp version                          hole/
          cp hole.sh                          hole/
          cp docker-compose.yml               hole/
          cp uninstall.sh                     hole/
          mkdir -p hole/agents/claude
          cp agents/claude/Dockerfile         hole/agents/claude/
          cp agents/claude/entrypoint.sh      hole/agents/claude/
          mkdir -p hole/proxy
          cp proxy/Dockerfile                 hole/proxy/
          cp proxy/tinyproxy.conf             hole/proxy/
          cp proxy/allowed-domains.txt        hole/proxy/
          mkdir -p hole/schema
          cp schema/settings.schema.json      hole/schema/
          tar -czf hole.tar.gz hole

      - name: Create release
        id: release
        uses: release-drafter/release-drafter@v5
        with:
          version: ${{ steps.version.outputs.version }}
          publish: true

      - name: Upload hole.tar.gz to release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./hole.tar.gz
          asset_name: Hole (tar.gz)
          asset_content_type: application/gzip
